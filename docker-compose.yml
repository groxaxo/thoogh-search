# Modern docker-compose format (v2+) does not require version specification
# Memory limits are supported in Compose v2+ without version field

services:
  whoogle-search:
    image: ${WHOOGLE_IMAGE:-benbusby/whoogle-search}
    container_name: whoogle-search
    restart: unless-stopped
    pids_limit: 50
    mem_limit: 256mb
    memswap_limit: 256mb
    # user debian-tor from tor package
    user: whoogle
    security_opt:
      - no-new-privileges
    cap_drop:
      - ALL
    tmpfs:
      - /config/:size=10M,uid=927,gid=927,mode=1700
      - /var/lib/tor/:size=15M,uid=927,gid=927,mode=1700
      - /run/tor/:size=1M,uid=927,gid=927,mode=1700
    # Health check for container monitoring
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    # Logging configuration (JSON for log aggregation)
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service,environment"
        tag: "{{.Name}}/{{.ID}}"
    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
    #environment: # Uncomment to configure environment variables
      # Basic auth configuration, uncomment to enable
      #- WHOOGLE_USER=<auth username>
      #- WHOOGLE_PASS=<auth password>
      # Proxy configuration, uncomment to enable
      #- WHOOGLE_PROXY_USER=<proxy username>
      #- WHOOGLE_PROXY_PASS=<proxy password>
      #- WHOOGLE_PROXY_TYPE=<proxy type (http|https|socks4|socks5)
      #- WHOOGLE_PROXY_LOC=<proxy host/ip>
      # Site alternative configurations, uncomment to enable
      # Note: If not set, the feature will still be available
      # with default values.
      #- WHOOGLE_ALT_TW=farside.link/nitter
      #- WHOOGLE_ALT_YT=farside.link/invidious
      #- WHOOGLE_ALT_IG=farside.link/bibliogram/u
      #- WHOOGLE_ALT_RD=farside.link/libreddit
      #- WHOOGLE_ALT_MD=farside.link/scribe
      #- WHOOGLE_ALT_TL=farside.link/lingva
      #- WHOOGLE_ALT_IMG=farside.link/rimgo
      #- WHOOGLE_ALT_WIKI=farside.link/wikiless
      #- WHOOGLE_ALT_IMDB=farside.link/libremdb
      #- WHOOGLE_ALT_QUORA=farside.link/quetre
      #- WHOOGLE_ALT_SO=farside.link/anonymousoverflow
      # Security headers
      #- WHOOGLE_CSP=1
      # Search provider options (2026 reliability)
      #- WHOOGLE_CONFIG_USE_CSE=0  # Use Google Custom Search API
      #- WHOOGLE_CONFIG_CSE_API_KEY=your-api-key
      #- WHOOGLE_CONFIG_CSE_ID=your-cse-id
      #- WHOOGLE_CONFIG_USE_SEARXNG=0  # Route through SearXNG
      #- WHOOGLE_CONFIG_SEARXNG_URL=https://searx.example.com
    #env_file: # Alternatively, load variables from whoogle.env
      #- whoogle.env
    ports:
      - "5000:5000"
    # Network isolation (optional, for advanced setups)
    # networks:
    #   - whoogle-net

# Optional: Create isolated network
# networks:
#   whoogle-net:
#     driver: bridge
#     ipam:
#       config:
#         - subnet: 172.28.0.0/16

